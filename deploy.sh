#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ó–∞–ø—É—Å–∫–∞—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã

echo "üöÄ –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∏–∑–º–µ–Ω–∏—Ç–µ –ø–æ–¥ –≤–∞—à —Å–µ—Ä–≤–µ—Ä)
SERVER_USER="root"
SERVER_HOST="80.90.183.91"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
SERVER_PROJECT_DIR="/opt/telegram_bots/reminder_bot"
SERVICE_NAME="reminder-bot.service"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–æ–ø—Ü–∏–∏]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  --help, -h     –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo "  --init         –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "  --update       –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    echo "  --status       –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞"
    echo "  --logs         –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 --init      # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞"
    echo "  $0 --update    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞"
    echo "  $0 --status    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
    exit 0
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
run_on_server() {
    ssh "$SERVER_USER@$SERVER_HOST" "$1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
copy_to_server() {
    scp "$1" "$SERVER_USER@$SERVER_HOST:$2"
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
init_server() {
    log "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    if run_on_server "[ -d '$SERVER_PROJECT_DIR/.git' ]"; then
        log "Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
        
        # –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        copy_to_server "simple_update.sh" "/tmp/"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        run_on_server "chmod +x /tmp/simple_update.sh && /tmp/simple_update.sh"
    else
        log "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        copy_to_server "init_server_git.sh" "/tmp/"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        run_on_server "chmod +x /tmp/init_server_git.sh && /tmp/init_server_git.sh"
    fi
    
    if [ $? -eq 0 ]; then
        log "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    else
        error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
        exit 1
    fi
}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
update_server() {
    log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git
    log "–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Git..."
    git add .
    git commit -m "Update: $(date '+%Y-%m-%d %H:%M:%S')"
    git push origin main
    
    if [ $? -ne 0 ]; then
        error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Git"
        exit 1
    fi
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    copy_to_server "deploy_update.sh" "/tmp/"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    run_on_server "chmod +x /tmp/deploy_update.sh && /tmp/deploy_update.sh"
    
    if [ $? -eq 0 ]; then
        log "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    else
        error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏"
        exit 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
check_status() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
    
    run_on_server "systemctl status $SERVICE_NAME --no-pager"
    
    echo ""
    info "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
    run_on_server "journalctl -u $SERVICE_NAME --no-pager -n 10"
}

# –ü–æ–∫–∞–∑ –ª–æ–≥–æ–≤
show_logs() {
    log "–ü–æ–∫–∞–∑ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–∏—Å–∞..."
    
    run_on_server "journalctl -u $SERVICE_NAME -f"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$1" in
    "--init")
        init_server
        ;;
    "--update")
        update_server
        ;;
    "--status")
        check_status
        ;;
    "--logs")
        show_logs
        ;;
    "")
        # –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
        echo "1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Git –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        echo "2) –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        echo "3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞"
        echo "4) –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
        echo "5) –í—ã—Ö–æ–¥"
        echo ""
        read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-5): " choice
        
        case $choice in
            1) init_server ;;
            2) update_server ;;
            3) check_status ;;
            4) show_logs ;;
            5) exit 0 ;;
            *) error "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä" ;;
        esac
        ;;
    *)
        error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
        exit 1
        ;;
esac
